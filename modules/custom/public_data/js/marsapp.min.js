"use strict";var app=angular.module("app",["720kb.tooltips","angucomplete-alt","ui.bootstrap","ngStorage"]);app.config(["$httpProvider","$compileProvider","$locationProvider",function($httpProvider,$compileProvider,$locationProvider){$httpProvider.defaults.headers.get||($httpProvider.defaults.headers.get={}),$httpProvider.defaults.headers.get["If-Modified-Since"]="Mon, 26 Jul 1997 05:00:00 GMT",$httpProvider.defaults.headers.get["Cache-Control"]="no-cache",$httpProvider.defaults.headers.Pragma="no-cache",$locationProvider.html5Mode({enabled:!0,requireBase:!1}),$locationProvider.html5Mode(!0)}]),angular.module("app").run(["$templateCache",function($templateCache){$templateCache.put("templateCache/custom-datepicker.tmpl.html",'<div class="custom-datepicker custom-cal controls mars-form-control form-control width-full" ng-click="open($event)" tabindex="{{tabindex}}" ng-class="{\'disabled\': isDisabled}"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i><input type="text" class="form-control" uib-datepicker-popup="{{format}}" readonly="readonly" ng-model="dt" is-open="status.opened" show-button-bar="{{!hideButtonBar}}" datepicker-append-to-body="true" datepicker-options="dateOptions"><b class="caret"></b></div>'),$templateCache.put("templateCache/datagrid-view.tmpl.html",'<div class="datagrid-view"><div class="dataTables_wrapper"><table class="table nowrap inner-dataTable dataTable nofooter" id="{{tableId}}"><thead><th ng-repeat="col in tableColumns track by col.attrId" ng-click="sort(col)" id="{{tableId + \'__\' + col.attrId}}" ng-if="col.isFirstRow"><span>{{col.name}}</span>&nbsp;<i class="sort-icon fa" ng-class="{\n                            \'fa-sort-asc\': gridState.order.column && gridState.order.column.attrId == col.attrId && gridState.order.asc, \n                            \'fa-sort-desc\': gridState.order.column && gridState.order.column.attrId == col.attrId && !gridState.order.asc}" ng-if="col.attrId != $scope.controlChildRowId"></i></th></thead><tbody ng-hide="gridState.isFiltering || !gridState.records || gridState.records.length == 0"><tr ng-repeat-start="record in gridState.records track by record.id"><td ng-repeat="field in tableColumns track by field.attrId" ng-if="field.isFirstRow" ng-include="\'row_renderer.html\'"></td></tr><tr ng-repeat-end ng-if="rowState[record.id].showingChildRow" ng-class="{\'highlight-row\': record.statusCode == \'E\'}"><td colspan="{{firstRowLength + 2}}"><div style="margin-left: 25px"><table class="width-full"><thead><tr><th ng-repeat="col in secondRowCols track by col.attrId"><span>{{col.name}}</span></th></tr></thead><tbody><tr><td ng-repeat="field in secondRowCols track by field.attrId" ng-include="\'row_renderer.html\'"></td></tr></tbody></table></div></td></tr></tbody><tbody class="ng-hide" ng-show="!gridState.isFiltering && (!gridState.records || gridState.records.length == 0)"><tr class="odd"><td valign="top" colspan="{{tableColumns.length}}" class="dataTables_empty">No data available in table.</td></tr></tbody><tbody class="ng-hide" ng-show="gridState.isFiltering"><tr class="odd"><td valign="top" colspan="{{tableColumns.length}}" class="dataTables_empty"><b>LOADING...</b></td></tr></tbody></table><div class="dataTables_length"><label><select class="form-control input-sm" ng-model="gridState.pageSize" ng-change="refreshData()" ng-if="tableOptions.showPageSize"><option value="10">10</option><option value="25">20</option><option value="50">50</option><option value="100">100</option></select></label></div><div class="dataTables_paginate paging_full_numbers"><ul class="pagination" uib-pagination total-items="gridState.totalRecords" items-per-page="gridState.pageSize" ng-model="gridState.pageIndex" ng-if="tableOptions.paging" ng-change="refreshData()" boundary-link-numbers="true" rotate="true" max-size="5"></ul></div></div><script type="text/ng-template" id="row_renderer.html"><div ng-if="field.attrId != controlChildRowId">\n             {{record[field.attrId]}}\n        </div> \n        <div ng-if="field.attrId == controlChildRowId" class="mars-tooltip" title="Control">\n            <a ng-click="showChildRow(record)" style="color: #2a5c0b; font-size: 16px;">\n                <i class="fa" \n                    ng-class="{\'fa-plus-circle\' : !rowState[record.id].showingChildRow, \'fa-minus-circle\' : rowState[record.id].showingChildRow }"></i>\n            </a>\n        </div><\/script></div>'),$templateCache.put("templateCache/loading.tmpl.html",'<div id="preloader"><div class="loader"><span></span><span></span><span></span><span></span></div></div>'),$templateCache.put("templateCache/search-box.tmpl.html",'<div class="search-box-wrapper"><div class="angucomplete-wrapper"><angucomplete-alt id="ex1" placeholder="Search column" pause="100" selected-object="selectedAttribute" local-data="tableColumns" search-fields="name" title-field="name" minlength="2" input-class="form-control form-control-small mars-tooltip" clear-selected="true" focus-out="focusOut()" input-changed="inputChanged" ng-show="!selectedAttribute"></div><div ng-show="selectedAttribute" class="input-group"><div id="attrTab" class="attrTab input-group-addon">{{selectedAttribute.title}}<a ng-click="clearSearch();" style="cursor: pointer;color: #555">&nbsp;<i class="fa fa-remove"></i></a></div><input id="attrVal" type="text" ng-model="selectedValue" class="form-control attrVal" tabindex="0/"></div></div>'),$templateCache.put("templateCache/section-filter.tmpl.html",'<div class="mars-accordion-section" id="section-filter"><div ng-click="toggleHeading($event)" data-target="#section-filter-content" class="row mars-accordion-header"><div class="col-sm-4 col-md-6"><h3><i ng-hide="collapse" class="fa fa-angle-down"></i><i ng-show="collapse" class="fa fa-angle-right"></i>Search for Commodities</h3></div></div><div id="section-filter-content" class="mars-accordion-content clearfix"><div class="col-sm-4"><b>Commodities</b><p>Type</p><select name="commodityType" chosen search-contains="true" placeholder-text-single="\'Select type\'" ng-model="filter.commodityType" class="form-control"><option ng-repeat="commodityType in commodityTypes track by $index" value="{{commodityType}}">{{commodityType}}</option></select><div ng-show="filter.commodityType == \'Commodity\'"><p>Commodity</p><select name="commodity" chosen search-contains="true" placeholder-text-single="\'Select commodity\'" ng-model="filter.commodity" class="form-control"><option ng-repeat="commodity in commodities track by $index" value="{{commodity.commodity}}">{{commodity.commodity}}</option></select></div><div ng-show="filter.commodityType == \'Office\'"><p>Office</p><select name="office" chosen search-contains="true" placeholder-text-single="\'Select office\'" ng-model="filter.office" class="form-control"><option ng-repeat="office in offices track by $index" value="{{office.office_name}}">{{office.office_name}}</option></select></div><div ng-show="filter.commodityType == \'Report\'"><p>Report</p><select name="report" chosen search-contains="true" placeholder-text-single="\'Select report\'" ng-model="filter.report" class="form-control"><option ng-repeat="report in reports track by $index" value="{{report.report_name}}">{{report.report_name}}</option></select></div></div><div class="col-sm-4"><b>Location</b><p>Select State</p><select name="state" chosen search-contains="true" placeholder-text-single="\'Select state\'" ng-model="filter.marketLocationState" class="form-control"><option value="">Select state</option><option ng-repeat="state in marketLocationStates track by $index" value="{{state}}">{{state}}</option></select><p>Select Market Location</p><select name="state" chosen search-contains="true" placeholder-text-single="\'Select market location\'" ng-model="filter.marketLocation" class="form-control"><option value="">Select state</option><option ng-repeat="marketLocation in marketLocations track by $index" value="{{marketLocation.market_name}}">{{marketLocation.market_name}}</option></select></div><div class="col-sm-4"><b>Time</b><p>Select From Date</p><custom-datepicker date-model="filter.reportFromDate" date-object="true" max-date="reportMaxDate"></custom-datepicker><p>Select To Date</p><custom-datepicker date-model="filter.reportToDate" date-object="true" max-date="reportMaxDate"></custom-datepicker><p>Select period</p><select name="period" chosen search-contains="true" placeholder-text-single="\'Select period\'" ng-model="filter.period" class="form-control"><option value="">Select period</option><option ng-repeat="period in periods track by $index" value="{{period.name}}">{{period.name}}</option></select></div><div class="col-sm-12 action-bar"><div class="col-sm-8 pull-left" style="color: red"><p ng-repeat="errMsg in errMessages track by $index">{{errMsg}}</p></div><div class="col-sm-2 pull-right"><a class="btn mars-form-control form-control" ng-click="getData()">GET DATA</a></div><div class="col-sm-2 pull-right"><a class="btn mars-form-control form-control" ng-click="clearFilter()">CLEAR</a></div></div></div></div>'),$templateCache.put("templateCache/section-result.tmpl.html",'<div class="mars-accordion-section" id="section-result"><div ng-click="toggleHeading($event)" data-target="#section-result-content" class="row mars-accordion-header"><div class="col-sm-4 col-md-6"><h3><i ng-hide="collapse" class="fa fa-angle-down"></i><i ng-show="collapse" class="fa fa-angle-right"></i>Result</h3></div></div><div id="section-result-content" class="mars-accordion-content clearfix"><div ng-if="filterFields && filterFields.length > 0" class="col-sm-12"><div class="mars-accordion-section"><div ng-click="toggleHeadingFilter($event)" data-target="#section-result-filter" class="row mars-accordion-header"><div class="col-sm-4 col-md-6"><h3><i ng-hide="filterCollapse" class="fa fa-angle-down"></i><i ng-show="filterCollapse" class="fa fa-angle-right"></i>Filter result</h3></div></div><div id="section-result-filter" class="mars-accordion-content clearfix result-filter" style="display: none"><div class="col-sm-12"><div class="col-sm-3" ng-repeat="field in filterFields"><span>{{field.name}}</span><input type="text" name="{{field.name}}" ng-model="resultFilter[field.attrId]" class="form-control"></div></div><div class="col-sm-12"><div class="col-sm-2 pull-right filter-btn"><a class="btn mars-form-control form-control" ng-click="filterData()">Filter</a></div><div class="col-sm-2 pull-right"><a class="btn mars-form-control form-control" ng-click="resetFilterData()">Reset Filter</a></div></div></div></div></div><div class="col-sm-12" ng-if="!filtering && (!groupRecords || !groupRecords.length)"><p class="no-data">No data available</p></div><div class="col-sm-12 table-result" ng-if="!filtering && groupRecords && groupRecords.length"><div class="control-bar clearfix"><div class="col-sm-2"><a ng-show="!collapsed" class="btn mars-form-control form-control" ng-click="toggleCollapseAll()"><i class="fa fa-minus-circle"></i>&nbsp;&nbsp;Collapse All</a><a ng-show="collapsed" class="btn mars-form-control form-control" ng-click="toggleCollapseAll()"><i class="fa fa-plus-circle"></i>&nbsp;&nbsp;Expand All</a></div></div><div ng-repeat="group in groupRecords track by $index" class="group-records"><p class="group-key" ng-click="toggleCollapseGroup(group)"><span style="margin-right: 5px"><i ng-show="group.collapsed" class="fa fa-plus-circle"></i><i ng-show="!group.collapsed" class="fa fa-minus-circle"></i></span>{{group.key}}</p><div ng-show="!group.collapsed"><datagrid-view table-columns="group.tableColumns" table-data="group.records" table-options="tableOptions"></datagrid-view></div></div></div></div></div>')}]),app.constant("COLLECTION_FREQUENCY",{DAILY:"daily",WEEKLY:"weekly",MONTHLY:"monthly",YEARLY:"yearly"}).constant("DEFAULT_SORT_COL","report_date").constant("DATE_FORMAT","MM/DD/YYYY"),app.controller("mainController",["$scope","$rootScope","DataFactory","$q","$timeout",function($scope,$rootScope,DataFactory,$q,$timeout){}]),app.directive("customDatepicker",["$parse","COLLECTION_FREQUENCY","DATE_FORMAT",function($parse,COLLECTION_FREQUENCY,DATE_FORMAT){return{templateUrl:"templateCache/custom-datepicker.tmpl.html",scope:{dateModel:"="},link:function(scope,elem,attrs){function init(maxDate){var options={format:"MM/dd/yyyy",yearFormat:"yy",startingDay:1,minDate:minDate,maxDate:maxDate,appendToBody:!0};collectFrequency==COLLECTION_FREQUENCY.WEEKLY?options.dateDisabled=function(dateMode){return"day"===dateMode.mode&&1!=dateMode.date.getDay()}:collectFrequency==COLLECTION_FREQUENCY.MONTHLY?options={format:"MMMM yyyy",formatMonth:"MMMM",formatYear:"yyyy",minMode:"month",minDate:minDate,maxDate:maxDate,appendToBody:!0}:collectFrequency==COLLECTION_FREQUENCY.YEARLY&&(options={format:"yyyy",formatYear:"yyyy",minMode:"year",minDate:minDate,maxDate:maxDate,appendToBody:!0}),scope.dateOptions=options,scope.format=scope.dateOptions.format}var minDate=moment().subtract(30,"years").toDate(),collectFrequency=(attrs.maxDate&&""!=attrs.maxDate&&$parse(attrs.maxDate)(scope),attrs.collectFrequency&&""!=attrs.collectFrequency?$parse(attrs.collectFrequency)(scope):null),isModelDateObj=attrs.dateObject&&"true"==attrs.dateObject;scope.hideButtonBar=attrs.hideButtonBar&&"true"==attrs.hideButtonBar,scope.tabindex=attrs.tab?attrs.tab:0,scope.$watch(function(){return scope[attrs.maxDate]},function(maxDate){init(maxDate)}),scope.$watch(function(){return scope.dateModel},function(value){if(value)if(isModelDateObj)scope.dt=value;else{var tmpDate=moment(value,DATE_FORMAT);tmpDate.isValid()?scope.dt=tmpDate.toDate():scope.dt=null}else scope.dt=null}),scope.$watch(function(){return $parse(attrs.ngDisabled)(scope)},function(isDisabled){scope.isDisabled=isDisabled});var model=scope.dateModel,dateObj=null;model&&""!=model&&(dateObj=isModelDateObj?model:moment(model,DATE_FORMAT).toDate()),null!=dateObj?(scope.dateModel=isModelDateObj?dateObj:model,scope.dt=dateObj):scope.dt=null,scope.$watch(function(){return scope.dt},function(newDate){var newDateStr=(newDate=newDate||null)?moment(newDate).format(DATE_FORMAT):null;scope.dateModel=isModelDateObj?newDate:newDateStr}),scope.status={opened:!1},scope.open=function($event){scope.status.opened=!0}}}}]),app.directive("datagridView",["$timeout","$rootScope","CommonFactory","DEFAULT_SORT_COL",function($timeout,$rootScope,CommonFactory,DEFAULT_SORT_COL){return{restrict:"E",templateUrl:"templateCache/datagrid-view.tmpl.html",scope:{tableColumns:"=",tableData:"=",tableOptions:"=",searchControlId:"="},link:function(scope,element){$timeout(function(){element.find(".mars-tooltip:not(.tooltipstered)").tooltipster()},0,!1)},controller:["$scope",function($scope){function refreshData(updateResponsive){$timeout(function(){var records=[],originalRecords=$scope.tableData||[],selectedIndexFrom=parseInt(0==$scope.gridState.pageIndex?0:$scope.gridState.pageIndex-1)*parseInt($scope.gridState.pageSize);selectedIndexFrom=selectedIndexFrom>0?selectedIndexFrom:0,$scope.gridState.order&&$scope.gridState.order.column&&(originalRecords=_.sortByOrder(originalRecords,function(record){var fieldData=record[$scope.gridState.order.column.attrId?$scope.gridState.order.column.attrId:$scope.gridState.order.column];return fieldData?fieldData.label?fieldData.label:fieldData:null},$scope.gridState.order.asc)),$scope.tableOptions.searching&&$scope.gridState.search&&$scope.gridState.search.length>0&&_.forEach($scope.gridState.search,function(searchCon){originalRecords=searchCon.column?_.filter(originalRecords,function(record){var recordValue=record[searchCon.column.attrId];return(recordValue=recordValue?recordValue.id?recordValue.label:recordValue:null)&&(recordValue+"").toLowerCase().indexOf(searchCon.text.toLowerCase())>=0}):_.filter(originalRecords,function(record){for(var prop in record.customObject)if(record.customObject.hasOwnProperty(prop)){var recordValue=record.customObject[prop].label;if(recordValue&&(recordValue+"").toLowerCase().indexOf(searchCon.text.toLowerCase())>=0)return!0}return!1})});var selectedIndexTo=selectedIndexFrom+parseInt($scope.gridState.pageSize);_.forEach(originalRecords,function(record,index){index>=selectedIndexFrom&&index<selectedIndexTo&&records.push(record)}),$scope.gridState.totalRecords=originalRecords?originalRecords.length:0,$scope.gridState.records=records,$scope.gridState.isFiltering=!1,updateResponsive&&updateResponsiveView()})}function searchCallBack(searchConditionList){$scope.gridState.search=[],_.forEach(searchConditionList,function(searchCon){$scope.gridState.search.push({column:_.find($scope.tableColumns,{attrId:searchCon.attrId}),text:searchCon.searchValue})}),refreshData(!0)}function sortable(column){return column.attrId!=$scope.controlChildRowId}function setAllColumnsShowinOneLine(){_.forEach($scope.tableColumns,function(col,index){col.attrId!=$scope.controlChildRowId?col.isFirstRow=!0:col.isFirstRow=!1})}function updateResponsiveView(){setAllColumnsShowinOneLine(),$timeout(function(){var $table=$("#"+$scope.tableId),wrapperClass=$scope.tableOptions.wrapperClass?$scope.tableOptions.wrapperClass:"dataTables_wrapper",expectedWidth=$table.closest("."+wrapperClass).width();if(expectedWidth){var currentWidth=0,secondRowCols=[],lastColOfFirstRowIndex=-1;if(_.forEach($scope.tableColumns,function(col,index){var thId=$scope.tableId+"__"+col.attrId;currentWidth<=expectedWidth?(currentWidth+=$("#"+thId).outerWidth(),lastColOfFirstRowIndex=index):(secondRowCols.push(angular.copy(col)),col.isFirstRow=!1)}),currentWidth>expectedWidth&&!secondRowCols.length&&(lastColOfFirstRowIndex=$scope.tableColumns.length-1),lastColOfFirstRowIndex>=0&&currentWidth>expectedWidth)for(;currentWidth+30>expectedWidth;){var col=$scope.tableColumns[lastColOfFirstRowIndex],thId=$scope.tableId+"__"+col.attrId;currentWidth-=$("#"+thId).outerWidth(),col.isFirstRow=!1,secondRowCols.unshift(angular.copy(col)),lastColOfFirstRowIndex--}$scope.secondRowCols=secondRowCols,console.log("secondRowCols",$scope.tableId,secondRowCols),$scope.firstRowLength=_.countBy($scope.tableColumns,function(col){return col.isFirstRow})[!0];var controlCol=_.find($scope.tableColumns,{attrId:$scope.controlChildRowId});controlCol&&($scope.secondRowCols.length>0?controlCol.isFirstRow=!0:controlCol.isFirstRow=!1)}})}$scope.tableOptions.pageSize+="",$scope.rowState={},$scope.gridState={records:[],search:[],order:{column:{attrId:DEFAULT_SORT_COL},asc:!1},pageSize:$scope.tableOptions.pageSize,pageIndex:$scope.tableOptions.pageIndex,totalRecords:$scope.tableData?$scope.tableData.length:0,isFiltering:!0},$scope.tableId=CommonFactory.generateUUID(),$scope.refreshData=refreshData,$scope.searchCallBack=searchCallBack,$scope.searchReset=function(){$scope.gridState.search=[],refreshData(!0)},$scope.sort=function(column){sortable(column)&&($scope.gridState.order.column||($scope.gridState.order.column={}),$scope.gridState.order.asc=$scope.gridState.order.column.attrId!=column.attrId||!$scope.gridState.order.asc,$scope.gridState.order.column=column,refreshData(!0))},$scope.showChildRow=function(record){var recordId=record.id;void 0===$scope.rowState[recordId]?$scope.rowState[recordId]={showingChildRow:!0}:$scope.rowState[recordId].showingChildRow=!$scope.rowState[recordId].showingChildRow},$scope.controlChildRowId="column-controlled-child-rows";$scope.tableOptions.searching&&$scope.$on("datagrid.search",function(event,searchConditionList){searchCallBack(searchConditionList)}),setAllColumnsShowinOneLine(),refreshData(!0);var existingWidth=$(window).width();$(window).resize(function(){var newWidth=$(window).width();existingWidth!=newWidth&&(existingWidth=newWidth,updateResponsiveView())})}]}}]),app.directive("loading",["$http",function($http){return{restrict:"E",templateUrl:"templateCache/loading.tmpl.html",link:function(scope,elm,attrs){scope.isLoading=function(){return!!$http.pendingRequests.length&&!_.find($http.pendingRequests,{hideLoading:!0})},scope.$watch(scope.isLoading,function(v){v?elm.show():elm.hide()})}}}]),app.directive("backTop",function(){return{restrict:"E",replace:!0,template:'<div class="back-to-top"><i class="fa fa-chevron-up"></i></div>',link:function($scope,element,attrs){$(window).scroll(function(){$(window).scrollTop()<=0?$(element).fadeOut():$(element).fadeIn()}),$(element).on("click",function(){$("html, body").animate({scrollTop:0},"fast")})}}}),app.directive("dcSearchBox",["CommonFactory","$timeout",function(CommonFactory,$timeout){return{replace:!0,templateUrl:"templateCache/search-box.tmpl.html",restrict:"E",scope:{tableColumns:"=",searchSubmit:"&",clearSearchCallBack:"&"},link:function(scope,elem,attrs){scope.searchValue=null,scope.clearSearch=function(){scope.selectedAttribute=void 0,scope.selectedValue=void 0,scope.clearSearchCallBack({})},scope.focusOut=function(){elem.find("#attrVal").focus()},scope.inputChanged=function(value){scope.searchValue=value},elem.find("#attrVal").bind("keydown keypress",function(event){13===event.which&&(scope.searchSubmit({$attrId:scope.selectedAttribute.originalObject.attrId,$searchValue:scope.selectedValue}),event.preventDefault())}),elem.find(".angucomplete-wrapper").bind("keydown keypress",function(event){$timeout(function(){13!==event.which||scope.selectedAttribute||(scope.searchSubmit({$attrId:null,$searchValue:scope.searchValue}),event.preventDefault())},500)})}}}]),app.directive("sectionFilter",["$parse","DataFactory","$q","$timeout","$rootScope","CommonFactory",function($parse,DataFactory,$q,$timeout,$rootScope,CommonFactory){return{restrict:"E",replace:!0,templateUrl:"templateCache/section-filter.tmpl.html",scope:{dataModel:"="},link:function(scope,elem,attrs){function getInitFilterObj(){return{commodityType:"Commodity",commodity:null,office:null,report:null,marketLocationState:null,marketLocation:null,reportFromDate:new Date,reportToDate:new Date,period:null}}function isFilterValid(){var errMessages=[];return"Commodity"!=scope.filter.commodityType||scope.filter.commodity?"Office"!=scope.filter.commodityType||scope.filter.office?"Report"!=scope.filter.commodityType||scope.filter.report||errMessages.push("Report is required."):errMessages.push("Office is required."):errMessages.push("Commodity is required."),scope.filter.reportFromDate>scope.filter.reportToDate&&errMessages.push("Report From Date must be before the Report To Date."),scope.errMessages=errMessages,!errMessages.length}function prePopulateData(){var queryCommodity=CommonFactory.getParameterByName("sel-commodity"),queryState=CommonFactory.getParameterByName("sel-state"),state=_.find(scope.marketLocationStates,function(st){return st==queryState});state&&(scope.filter.marketLocationState=state);var commodity=_.find(scope.commodities,function(com){return com.commodity==queryCommodity});commodity&&(scope.filter.commodity=commodity.commodity,scope.getData())}scope.toggleHeading=function(event){scope.collapse=!scope.collapse;var collapseTarget=$($(event.currentTarget).data("target"));scope.collapse?collapseTarget.slideUp(300):collapseTarget.slideDown(300)},scope.commodityTypes=["Commodity","Office","Report"],scope.states=[],scope.periods=[{value:0,name:"Annual"}],scope.filter=getInitFilterObj(),scope.reportMaxDate=new Date,scope.getData=function(){console.log("filter:",scope.filter),isFilterValid()&&$rootScope.$broadcast("data.filter",scope.filter)},scope.clearFilter=function(){scope.filter=getInitFilterObj(),$timeout(function(){elem.find("select[chosen]").trigger("chosen:updated")})},$q.all([DataFactory.getCommoditiesPromise(),DataFactory.getOfficesPromise(),DataFactory.getReportsPromise(),DataFactory.getMarketLocationStatesPromise(),DataFactory.getMarketLocationsPromise()]).then(function(data){console.log("Get all data success"),scope.commodities=DataFactory.commodities,scope.offices=DataFactory.offices,scope.reports=DataFactory.reports,scope.marketLocationStates=DataFactory.marketLocationStates,scope.marketLocations=DataFactory.marketLocations,$timeout(function(){elem.find("select[chosen]").chosen({disable_search_threshold:5,search_contains:!0})},500,!1),prePopulateData()}).catch(function(err){throw err})}}}]),app.directive("sectionResult",["$parse","DataFactory","$timeout","$rootScope",function($parse,DataFactory,$timeout,$rootScope){return{restrict:"E",replace:!0,templateUrl:"templateCache/section-result.tmpl.html",scope:{dataModel:"="},link:function(scope,elem,attrs){function toggleAccordion(event,collapsed){var collapseTarget=$($(event.currentTarget).data("target"));collapsed?collapseTarget.slideUp(300):collapseTarget.slideDown(300)}function showData(records){scope.tableColumns=DataFactory.tableColumns,scope.filterFields=_.filter(scope.tableColumns,function(col){return col.name});var group=_.groupBy(records,"groupKey"),groupRecords=[];for(var key in group)groupRecords.push({tableColumns:angular.copy(scope.tableColumns),key:key,records:group[key]});groupRecords=_.sortBy(groupRecords,"key"),scope.groupRecords=groupRecords,scope.filtering=!1}scope.toggleHeading=function(event){scope.collapse=!scope.collapse,toggleAccordion(event,scope.collapse)},scope.filterCollapse=!0,scope.toggleHeadingFilter=function(event){scope.filterCollapse=!scope.filterCollapse,toggleAccordion(event,scope.filterCollapse)},scope.tableOptions={pageSize:10,pageIndex:0,showPageSize:!0,searching:!0,info:!0,paging:!0,ordering:!0,isAddControlColumn:!0},scope.resultFilter={},scope.toggleCollapseGroup=function(group){group.collapsed=!group.collapsed},scope.toggleCollapseAll=function(){scope.collapsed=!scope.collapsed,_.forEach(scope.groupRecords,function(group){group.collapsed=scope.collapsed})},scope.$on("data.filter",function(event,filter){scope.filtering=!0;var queryParams={};filter.marketLocationState&&(queryParams.market_location_state=filter.marketLocationState),filter.marketLocation&&(queryParams.market_location=filter.marketLocation),filter.commodity?DataFactory.getCommodityDataPromise(filter.commodity,queryParams).then(function(commodityData){console.log("commodityData",commodityData),showData(commodityData)}):filter.office?DataFactory.getOfficeDataPromise(filter.office,queryParams).then(function(officeData){console.log("officeData",officeData),showData(officeData)}):filter.report?DataFactory.getReportDataPromise(filter.report,queryParams).then(function(reportData){console.log("reportData",reportData),showData(reportData)}):(scope.filtering=!1,scope.tableColumns=[],scope.groupRecords=[])}),scope.filterData=function(){var searchConditionList=[];for(var prop in scope.resultFilter)scope.resultFilter[prop]&&searchConditionList.push({attrId:prop,searchValue:scope.resultFilter[prop]});$rootScope.$broadcast("datagrid.search",searchConditionList)},scope.resetFilterData=function(){scope.resultFilter={},$rootScope.$broadcast("datagrid.search",[])}}}}]),app.factory("BaseFactory",["$http",function($http){return{getRequest:function(requestUrl,successCallback,errorCallback,headers,hideLoading){return this.request("GET",requestUrl,null,successCallback,errorCallback,headers,hideLoading)},postRequest:function(requestUrl,requestData,successCallback,errorCallback,headers,hideLoading){return this.request("POST",requestUrl,requestData,successCallback,errorCallback,headers,hideLoading)},request:function(method,url,data,successCallback,errorCallback,headers,hideLoading){return $http({method:method,url:url,data:data,headers:headers,hideLoading:hideLoading}).success(function(data,status,headers,config){403==status?alert("session expired"):successCallback&&successCallback(data,status,headers)}).error(function(data,status,headers,config){errorCallback&&errorCallback(data,status,headers)})},baseRequestUrl:function(){return"api/"}}}]),app.factory("CommonFactory",["BaseFactory","$q",function(BaseFactory,$q){var exports={};return exports.generateUUID=function(){var d=(new Date).getTime()+Math.floor(1e3*Math.random()+1);return Math.seedrandom(d.toLocaleString()),"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"==c?r:3&r|8).toString(16)})},String.prototype.replaceAll=function(strReplace,strWith){var esc=strReplace.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),reg=new RegExp(esc,"ig");return this.replace(reg,strWith)},exports.getRecursiveCompileFn=function($compile){return function(tElement,tAttr,transclude){var compiledContents,contents=tElement.contents().remove();return function(scope,iElement,iAttr){compiledContents||(compiledContents=$compile(contents,transclude)),compiledContents(scope,function(clone,scope){iElement.append(clone)})}}},exports.applyDiff=function(oldData,newData){angular.merge(oldData,newData);var a={data:oldData},b={data:newData};DeepDiff.applyDiff(a,b)},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(str){return this.slice(0,str.length)==str}),exports.showMessage=function(header,msg,$timeout){$.messager.show({title:header,msg:msg,timeout:6e3}).parent().addClass("panel-custom")},exports.showMessage4Ever=function(header,msg){$.messager.show({title:header,msg:msg,timeout:0}).parent().addClass("panel-custom panel-4ever")},exports.hide4EverMessage=function(){$(".panel-4ever").find("a.panel-tool-close").click()},exports.showAlert=function(header,msg){$.messager.alert(header,msg).parent().addClass("panel-custom")},exports.replaceAllByText=function(text,replaceText){return text&&""!=text?text.split(replaceText).join(" "):text},exports.getParameterByName=function(name,url){url||(url=window.location.href),name=name.replace(/[\[\]]/g,"\\$&");var results=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)").exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null},exports}]),app.factory("DataFactory",["CommonFactory","BaseFactory","$http","$q",function(CommonFactory,BaseFactory,$http,$q){function getDataPromise(entity,searchKey,queryParams){var defered=$q.defer(),queryStr="";if(queryParams)for(var param in queryParams)queryStr&&(queryStr+="&"),queryStr+=param+"="+queryParams[param];var requestUrl=baseUrl+entity+"/"+searchKey+"?"+queryStr;return BaseFactory.getRequest(requestUrl,function(data,status,headers,config){var records=data.results;createTableColumns(records),assignIdToRecord(records),defered.resolve(records)},function(data,status,headers,config){defered.reject([data,status,headers,config])}),defered.promise}function assignIdToRecord(records){var ids=[],id=CommonFactory.generateUUID();records&&records.length&&_.forEach(records,function(record){for(;ids.indexOf(id)>=0;)id=CommonFactory.generateUUID();record.id=id,ids.push(id),record.groupKey=record.group+" / "+record.category+" / "+record.commodity})}function createTableColumns(records){var tableColumns=[{attrId:"column-controlled-child-rows",name:""}];if(records&&records.length)for(var prop in records[0]){var colName=formatTableName(prop);excludeColumns.indexOf(colName)<0&&groupColumns.indexOf(colName)<0&&tableColumns.push({attrId:prop,name:colName})}exports.tableColumns=tableColumns}function formatTableName(colAttrId){return colAttrId.replaceAll("_"," ").split(" ").map(_.capitalize).join(" ")}var exports={},baseUrl="/services/v1/",excludeColumns=["Office Name","Office Code","Office City","Office State","Market Location Name","Market Location City","Market Location State","Market Type","Market Type Category"],groupColumns=["Group","Category","Commodity"];return exports.getCommoditiesPromise=function(){var defered=$q.defer(),requestUrl=baseUrl+"commodities";return exports[requestUrl]?(exports.commodities=angular.copy(exports[commodities]),defered.resolve([exports.commodities])):BaseFactory.getRequest(requestUrl,function(data,status,headers,config){exports.commodities=data,exports[requestUrl]=angular.copy(data),defered.resolve([data,status,headers,config])},function(data,status,headers,config){defered.reject([data,status,headers,config])}),defered.promise},exports.getOfficesPromise=function(){var defered=$q.defer(),requestUrl=baseUrl+"offices";return exports[requestUrl]?(exports.offices=angular.copy(exports[offices]),defered.resolve([exports.offices])):BaseFactory.getRequest(requestUrl,function(data,status,headers,config){exports.offices=data,exports[requestUrl]=angular.copy(data),defered.resolve([data,status,headers,config])},function(data,status,headers,config){defered.reject([data,status,headers,config])}),defered.promise},exports.getReportsPromise=function(){var defered=$q.defer(),requestUrl=baseUrl+"reports";return exports[requestUrl]?(exports.reports=angular.copy(exports[reports]),defered.resolve([exports.reports])):BaseFactory.getRequest(requestUrl,function(data,status,headers,config){exports.reports=data,exports[requestUrl]=angular.copy(data),defered.resolve([data,status,headers,config])},function(data,status,headers,config){defered.reject([data,status,headers,config])}),defered.promise},exports.getMarketLocationStatesPromise=function(){var defered=$q.defer(),requestUrl=baseUrl+"states";return exports[requestUrl]?(exports.marketLocationStates=angular.copy(exports[marketLocationStates]),defered.resolve([exports.marketLocationStates])):BaseFactory.getRequest(requestUrl,function(data,status,headers,config){exports.marketLocationStates=data,exports[requestUrl]=angular.copy(data),defered.resolve([data,status,headers,config])},function(data,status,headers,config){defered.reject([data,status,headers,config])}),defered.promise},exports.getMarketLocationsPromise=function(){var defered=$q.defer(),requestUrl=baseUrl+"markets";return exports[requestUrl]?(exports.marketLocations=angular.copy(exports[marketLocations]),defered.resolve([exports.marketLocations])):BaseFactory.getRequest(requestUrl,function(data,status,headers,config){exports.marketLocations=data,exports[requestUrl]=angular.copy(data),defered.resolve([data,status,headers,config])},function(data,status,headers,config){defered.reject([data,status,headers,config])}),defered.promise},exports.getCommodityDataPromise=function(commodityName,queryParams){return getDataPromise("commodities",commodityName,queryParams)},exports.getOfficeDataPromise=function(officeName,queryParams){return getDataPromise("offices",officeName,queryParams)},exports.getReportDataPromise=function(reportName){return getDataPromise("reports",reportName,queryParams)},exports}]);